@page
@model InventoryManagement.Pages.IndexModel
@using System
@{
    ViewData["Title"] = "House Buddy";

    var storageLocations = new[] { "Pantry", "Fridge", "Freezer", "Bathroom", "Cleaning", "Other" };
}

<div class="background-hero" aria-hidden="true">
    <div class="shape shape-left" aria-hidden="true">
        <svg viewBox="0 0 600 600" preserveAspectRatio="xMidYMid meet" width="100%" height="100%" xmlns="http://www.w3.org/2000/svg">
            <defs>
                <linearGradient id="g1" x1="0" x2="1" y1="0" y2="1">
                    <stop offset="0" stop-color="#FDEFE8" />
                    <stop offset="1" stop-color="#FBEFE8" />
                </linearGradient>
            </defs>
            <g fill="url(#g1)">
                <path d="M300 30C380 30 520 70 548 150C576 230 520 360 420 420C320 480 190 520 110 460C30 400 20 230 80 150C140 70 220 30 300 30Z" />
            </g>
        </svg>
    </div>

    <div class="shape shape-right" aria-hidden="true">
        <svg viewBox="0 0 520 520" preserveAspectRatio="xMidYMid meet" width="100%" height="100%" xmlns="http://www.w3.org/2000/svg">
            <defs>
                <linearGradient id="g2" x1="0" x2="1">
                    <stop offset="0" stop-color="#FFECD1" />
                    <stop offset="1" stop-color="#FDEFE8" />
                </linearGradient>
            </defs>
            <g fill="url(#g2)">
                <path d="M260 10C330 30 420 50 490 120C560 190 520 320 420 420C320 520 190 490 110 420C30 350 10 200 60 120C110 40 190 -10 260 10Z" />
            </g>
        </svg>
    </div>
</div>

<div class="container-xxl page-shell page-content home-outer">

    <div class="home-card mb-4">
        <div class="mb-3 d-flex justify-content-between align-items-center flex-wrap gap-2">
            <h1 class="page-title mb-0">Manage Items</h1>

            @if (TempData["Message"] is string msg)
            {
                <span class="text-success small">@msg</span>
            }
        </div>

        <div class="home-card-body">
            <label for="upcInput" class="form-label">Search by UPC</label>

            <form method="post" asp-page-handler="Search" class="mb-0" role="search" aria-label="Search by UPC">
                <div class="home-search-row">
                    <input id="upcInput"
                           name="UPC"
                           class="form-control"
                           value="@Model.UPC"
                           placeholder="e.g., 012345678905"
                           aria-label="UPC code" />
                    <button class="btn btn-lookup" type="submit">Lookup</button>
                </div>
            </form>


            @if (!ViewData.ModelState.IsValid)
            {
                <div class="alert alert-warning mt-3">
                    @foreach (var entry in ViewData.ModelState)
                    {
                        foreach (var error in entry.Value.Errors)
                        {
                            @error.ErrorMessage

                            <br />
                        }
                    }
                </div>
            }

            @if (Model.SearchedItem is not null)
            {
                var item = Model.SearchedItem;
                var imageUrl = (item.Images != null && item.Images.Count > 0)
                ? item.Images[0].ToString()
                : null;

                <div class="mt-3">
                    <div class="row g-3 align-items-start">
                        <div class="col-auto">
                            @if (imageUrl != null)
                            {
                                <img src="@imageUrl"
                                     alt="@item.Title"
                                     class="search-result-img" />
                            }
                        </div>

                        <div class="col">
                            <h5 class="mb-2">@item.Title</h5>
                            <div><span class="field-label">Brand:</span> @item.Brand</div>
                            <div><span class="field-label">Model:</span> @item.Model</div>
                            <div><span class="field-label">Category:</span> @item.Category</div>
                            <div><span class="field-label">UPC:</span> @item.Upc</div>

                            @* Nutri-Score badge for searched item *@
                            @if (!string.IsNullOrWhiteSpace(Model.SearchedNutriScoreGrade))
                            {
                                var nutri = Model.SearchedNutriScoreGrade.ToUpperInvariant();
                                <div class="mt-2">
                                    <span class="badge nutri-pill @($"nutri-{nutri}")">
                                        Nutri-Score @nutri
                                    </span>
                                </div>
                            }

                            @if (!string.IsNullOrWhiteSpace(Model.SearchedEcoScoreGrade))
                            {
                                var eco = Model.SearchedEcoScoreGrade.ToUpperInvariant();
                                <div class="mt-1">
                                    <span class="badge eco-pill @($"eco-{eco}")">
                                        Eco-Score @eco
                                    </span>
                                </div>
                            }

                            <hr class="mt-3 mb-3" />

                            <!-- ADD FORM -->
                            <form method="post" asp-page-handler="Add">
                                @* Hidden fields populated from the UPC API result *@
                                <input type="hidden" name="upc" value="@item.Upc" />
                                <input type="hidden" name="title" value="@item.Title" />
                                <input type="hidden" name="brand" value="@item.Brand" />
                                <input type="hidden" name="model" value="@item.Model.ToString()" />
                                <input type="hidden" name="category" value="@item.Category" />
                                @if (imageUrl != null)
                                {
                                    <input type="hidden" name="imageUrl" value="@imageUrl" />
                                }

                                @* Pass Nutri-Score to Add handler so it can be saved on Product *@
                                @if (!string.IsNullOrWhiteSpace(Model.SearchedNutriScoreGrade))
                                {
                                    <input type="hidden" name="nutriScoreGrade" value="@Model.SearchedNutriScoreGrade" />
                                }

                                @if (!string.IsNullOrWhiteSpace(Model.SearchedEcoScoreGrade))
                                {
                                    <input type="hidden" name="ecoScoreGrade" value="@Model.SearchedEcoScoreGrade" />
                                }

                                <div class="row g-3">
                                    <div class="col-6 col-md-3">
                                        <label class="field-label mb-1" for="addQty">Quantity</label>
                                        <input id="addQty"
                                               name="quantity"
                                               type="number"
                                               min="1"
                                               value="1"
                                               class="form-control" />
                                    </div>

                                    <div class="col-6 col-md-3">
                                        <label class="field-label mb-1" for="addExpiry">Expiry Date</label>
                                        <input id="addExpiry"
                                               name="expiryDate"
                                               type="date"
                                               class="form-control" />
                                    </div>

                                    <div class="col-12 col-md-4">
                                        <label class="field-label mb-1" for="addStorageLocation">Storage</label>
                                        <select id="addStorageLocation"
                                                name="storageLocation"
                                                class="form-select">
                                            <option value="">Select</option>
                                            @foreach (var loc in storageLocations)
                                            {
                                                <option value="@loc">@loc</option>
                                            }
                                        </select>
                                    </div>
                                </div>

                                <div class="mt-3 d-flex flex-wrap gap-2">
                                    <button class="btn btn-success" type="submit">Add to Inventory</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>

    <!-- INVENTORY SECTION -->
    <section class="inventory-section">
        <div id="inventory-top" class="inventory-header d-flex justify-content-between align-items-center flex-wrap gap-2 mb-2">
            <h2 class="section-title mb-0">My Inventory</h2>

            @if (Model.Products.Any())
            {
                <span class="inventory-count-pill">
                    @Model.Products.Count item@(Model.Products.Count == 1 ? "" : "s")
                </span>
            }
        </div>

        @if (!Model.Products.Any())
        {
            <p class="text-muted mb-0">No items in inventory yet. Search a UPC and add your first product.</p>
        }
        else
        {
            <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 row-cols-xxl-5 g-3 inventory-grid">
                @foreach (var p in Model.Products)
                {
                    var isEditing = Model.EditProductId.HasValue && Model.EditProductId.Value == p.Id;

                    <div class="col" id="product-@p.Id">
                        <div class="card inventory-card h-100">
                            @if (!string.IsNullOrEmpty(p.ImageUrl))
                            {
                                <img src="@p.ImageUrl"
                                     class="card-img-top inventory-card-img"
                                     alt="@p.Title" />
                            }

                            <div class="card-body d-flex flex-column inventory-card-body">
                                <div class="mb-2">
                                    <h5 class="card-title mb-1">@p.Title</h5>
                                    <div class="small text-muted">
                                        @if (!string.IsNullOrWhiteSpace(p.Brand))
                                        {
                                            <span>@p.Brand · </span>
                                        }
                                        <span>UPC: @p.UPC</span>
                                    </div>
                                </div>

                                @if (!string.IsNullOrWhiteSpace(p.Category))
                                {
                                    var categoryDisplay = p.Category;
                                    if (p.Category.Contains('>'))
                                    {
                                        categoryDisplay = p.Category.Split('>').Last().Trim();
                                    }

                                    <div class="mb-2">
                                        <span class="badge rounded-pill inventory-pill"
                                              title="@p.Category">
                                            @categoryDisplay
                                        </span>
                                    </div>
                                }

                                @* Nutri-Score badge on inventory cards *@
                                @if (!string.IsNullOrWhiteSpace(p.NutriScoreGrade))
                                {
                                    var nutriInv = p.NutriScoreGrade.ToUpperInvariant();
                                    <div class="mb-2">
                                        <span class="badge nutri-pill @($"nutri-{nutriInv}")">
                                            Nutri-Score @nutriInv
                                        </span>
                                    </div>
                                }

                                @if (!string.IsNullOrWhiteSpace(p.EcoScoreGrade))
                                {
                                    var ecoInv = p.EcoScoreGrade.ToUpperInvariant();
                                    <div class="mb-1">
                                        <span class="badge eco-pill @($"eco-{ecoInv}")">
                                            Eco-Score @ecoInv
                                        </span>
                                    </div>
                                }

                                @if (!isEditing)
                                {
                                    <div class="small mb-1">
                                        <strong>Quantity:</strong> @p.Quantity
                                    </div>

                                    @if (p.ExpiryDate.HasValue)
                                    {
                                        <div class="small mb-1">
                                            <strong>Expiry:</strong> @p.ExpiryDate.Value.ToString("yyyy-MM-dd")
                                        </div>
                                    }

                                    @if (!string.IsNullOrWhiteSpace(p.StorageLocation))
                                    {
                                        <div class="small mb-2">
                                            <strong>Storage:</strong> @p.StorageLocation
                                        </div>
                                    }

                                    <div class="mt-auto d-flex gap-2">
                                        <form method="post"
                                              asp-page-handler="StartEdit"
                                              asp-fragment="@($"product-{p.Id}")"
                                              class="d-inline js-preserve-scroll">
                                            <input type="hidden" name="id" value="@p.Id" />
                                            <button type="submit" class="btn btn-sm btn-outline-primary">
                                                Edit
                                            </button>
                                        </form>

                                        <form method="post" asp-page-handler="Delete" class="d-inline js-preserve-scroll">
                                            <input type="hidden" name="id" value="@p.Id" />
                                            <button type="submit"
                                                    class="btn btn-sm btn-outline-danger"
                                                    onclick="return confirm('Remove this product from inventory?');">
                                                Delete
                                            </button>
                                        </form>
                                    </div>
                                }
                                else
                                {
                                    <form method="post" asp-page-handler="Update" class="mt-2 js-preserve-scroll">
                                        <input type="hidden" name="id" value="@p.Id" />

                                        <div class="mb-2">
                                            <label class="form-label form-label-sm mb-1">Quantity</label>
                                            <input name="quantity"
                                                   type="number"
                                                   min="0"
                                                   value="@p.Quantity"
                                                   class="form-control form-control-sm" />
                                        </div>

                                        <div class="mb-2">
                                            <label class="form-label form-label-sm mb-1">Expiry Date</label>
                                            <input name="expiryDate"
                                                   type="date"
                                                   value="@(p.ExpiryDate?.ToString("yyyy-MM-dd") ?? "")"
                                                   class="form-control form-control-sm" />
                                        </div>

                                        <div class="mb-3">
                                            <label class="form-label form-label-sm mb-1">Storage</label>
                                            <select name="storageLocation"
                                                    class="form-select form-select-sm">
                                                <option value="">(none)</option>
                                                @foreach (var loc in storageLocations)
                                                {
                                                    <option value="@loc" selected="@(p.StorageLocation == loc)">
                                                        @loc
                                                    </option>
                                                }
                                            </select>
                                        </div>

                                        <div class="d-flex gap-2">
                                            <button type="submit" class="btn btn-sm btn-success">
                                                Save
                                            </button>
                                        </div>
                                    </form>

                                    <div class="d-flex gap-2 mt-2">
                                        <form method="post" asp-page-handler="CancelEdit" class="d-inline js-preserve-scroll">
                                            <input type="hidden" name="id" value="@p.Id" />
                                            <button type="submit" class="btn btn-sm btn-outline-secondary">
                                                Cancel
                                            </button>
                                        </form>

                                        <form method="post" asp-page-handler="Delete" class="d-inline js-preserve-scroll">
                                            <input type="hidden" name="id" value="@p.Id" />
                                            <button type="submit"
                                                    class="btn btn-sm btn-outline-danger"
                                                    onclick="return confirm('Remove this product from inventory?');">
                                                Delete
                                            </button>
                                        </form>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
    </section>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    
}
